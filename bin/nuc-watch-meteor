#!/usr/bin/env node

var cli = require("commander"),
    path = require("path"),
    watcher = require("../lib/fs_watcher"),
    app_inspector = require("../lib/app_crash_inspector.js"),
    backup_demon = require("../lib/backup_demon.js");

cli
  .version("0.0.1")
  .option("-d, --dir <dir>", "Directory to watch changes in")
  .option("-u, --url <url>", "Url where meteor app is running")
  .option("-p, --project <project>","Name of the project")
  .option("-w, --wait <n>","Wait time in milliseconds", parseInt)
  .option("-t, --test","Bla bla bla")
  .parse(process.argv);

if(cli.test) {

}

if (! cli.dir || ! cli.url || ! cli.project) {
  cli.help();
}

var dir = path.resolve(cli.dir),
    wait = cli.wait || 2000,
    url = cli.url.indexOf("http") === 0 ? cli.url : "http://"+cli.url,
    project_name = cli.project;

var demon = new backup_demon.Backup_Demon({app_dir: dir, project_name: project_name});

demon.setup();

watcher.start_watching(dir, wait, function() {
  //on every non-crashing change, we make a commit to our backup branch
  app_inspector.if_crashed('http://localhost:3000/', function() {

  });
});
